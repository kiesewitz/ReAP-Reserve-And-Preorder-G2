<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>Kellner – Übersicht</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { margin:0; font-family:"Poppins",sans-serif; background:#f4f6fa; color:#222; }
        header { background:#2b2f42; color:#fff; padding:20px 30px; font-size:26px; font-weight:600; }
        .container { max-width:1400px; margin:30px auto; padding:0 20px; }

        .grid { display:grid; grid-template-columns:1.3fr 1fr; gap:24px; }
        @media(max-width:1000px){ .grid{ grid-template-columns:1fr; } }

        .card { background:#fff; border-radius:14px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:20px; }
        .card h2 { margin:0 0 16px; font-size:22px; font-weight:600; }

        .table-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:16px; }
        .table-card { background:#f8f9fc; border:2px solid #ddd; border-radius:12px; padding:16px; font-size:18px; }
        .table-card .row { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }

        .badge { padding:6px 12px; border-radius:999px; font-size:14px; font-weight:500; }
        .status-BESTELLUNG_FERTIG { background:#d4f7e7; color:#157347; }
        .status-BELEGT            { background:#fff3cd; color:#856404; }
        .status-LEER              { background:#dbeafe; color:#1e3a8a; }
        .status-ESSEN             { background:#ede9fe; color:#5b21b6; }

        .table-card button { font-size:16px; padding:10px 14px; margin-top:6px; }

        .order { background:#f9fafb; border:2px solid #ddd; border-radius:12px; padding:16px; margin-bottom:14px; font-size:18px; }
        .order .row { display:flex; justify-content:space-between; margin-bottom:8px; }
        .order .items { font-size:16px; margin:6px 0; }
        .order button { font-size:16px; padding:10px 14px; }

        .toolbar { display:flex; gap:12px; margin-bottom:20px; }
        input[type=search]{ flex:1; font-size:18px; padding:12px 14px; border:2px solid #ccc; border-radius:10px; }
        button { cursor:pointer; border:none; border-radius:10px; background:#2b2f42; color:#fff; font-size:16px; font-weight:500; }
        button:hover { opacity:0.9; }
        .btn-gray { background:#6c757d; }
        .btn-green { background:#198754; }
    </style>
</head>
<body>
<header>Kellner – Tische & Bestellungen</header>

<div class="container grid">
    <!-- Tische -->
    <section class="card">
        <h2>Tische</h2>
        <div class="toolbar">
            <input id="q" type="search" placeholder="Suche Tisch / Bestellung / Item…" />
            <button id="refreshBtn" class="btn-gray">↻ Aktualisieren</button>
        </div>
        <div id="tables" class="table-grid"></div>
    </section>

    <!-- Bestellungen -->
    <section class="card">
        <h2>Offene Bestellungen</h2>
        <div id="orders"></div>
    </section>
</div>

<script>
    const API = {
        state: '/api/waiter/state',
        served: id => `/api/orders/${id}/served`,
        finishTable: id => `/api/tables/${id}/finish`
    };

    let DATA = { tables: [], orders: [] };

    const $ = sel => document.querySelector(sel);

    function renderTables(){
        const q = $('#q').value.toLowerCase().trim();
        const wrap = $('#tables'); wrap.innerHTML = '';

        DATA.tables
            .filter(t => !q || (t.name?.toLowerCase().includes(q) || String(t.id).includes(q)))
            .forEach(t => {
                const hasReady = DATA.orders.some(o => o.tableId === t.id && o.status === 'BEREIT');
                const div = document.createElement('div');
                div.className = 'table-card';
                div.innerHTML = `
          <div class="row">
            <strong>${t.name ?? ('Tisch ' + t.id)}</strong>
            <span class="badge status-${t.status}">${t.status}</span>
          </div>
          <div>Sitze: ${t.seats ?? '-'}</div>
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            <button data-jump="${t.id}">Bestellungen</button>
            ${hasReady || t.status==='ESSEN' ? `<button class="btn-green" data-finish="${t.id}">Tisch fertig</button>` : ``}
          </div>
        `;
                wrap.appendChild(div);
            });

        wrap.onclick = async (e)=>{
            const b = e.target.closest('button');
            if(!b) return;
            if(b.dataset.jump){
                const first = document.querySelector(`.order[data-table="${b.dataset.jump}"]`);
                if(first) first.scrollIntoView({behavior:'smooth',block:'start'});
            }
            if(b.dataset.finish){
                await fetch(API.finishTable(b.dataset.finish), { method:'POST' });
                await load();
            }
        };
    }

    function renderOrders(){
        const q = $('#q').value.toLowerCase().trim();
        const wrap = $('#orders'); wrap.innerHTML = '';

        DATA.orders
            .filter(o => o.status !== 'SERVIERT') // nur offene zeigen
            .filter(o => {
                if(!q) return true;
                const t = DATA.tables.find(t => t.id === o.tableId);
                const tableName = (t?.name || ('Tisch '+o.tableId)).toLowerCase();
                const items = (o.items||[]).map(i=>`${i.name} x${i.qty}`).join(' ').toLowerCase();
                return String(o.id).includes(q) || String(o.tableId).includes(q) || tableName.includes(q) || items.includes(q);
            })
            .sort((a,b)=> (a.status==='BEREIT'? -1:1) - (b.status==='BEREIT'? -1:1))
            .forEach(o => {
                const t = DATA.tables.find(t => t.id === o.tableId);
                const tableName = t?.name || ('Tisch ' + o.tableId);
                const div = document.createElement('div');
                div.className = 'order';
                div.dataset.table = o.tableId;
                div.innerHTML = `
          <div class="row">
            <div><strong>#${o.id}</strong> – ${tableName}</div>
            <span class="badge status-${o.status}">${o.status}</span>
          </div>
          <div class="items">${(o.items||[]).map(i=>`• ${i.name} × ${i.qty}`).join('<br>')}</div>
          <div style="text-align:right;margin-top:10px;">
            <button data-served="${o.id}">Serviert</button>
          </div>
        `;
                wrap.appendChild(div);
            });

        wrap.onclick = async (e)=>{
            const b = e.target.closest('button[data-served]');
            if(!b) return;
            await fetch(API.served(b.dataset.served), { method:'POST' });
            await load();
        };
    }

    async function load(){
        const res = await fetch(API.state, { headers: { 'Accept':'application/json' } });
        if(!res.ok){ console.error('API', res.status); return; }
        DATA = await res.json();
        renderTables(); renderOrders();
    }

    $('#q').addEventListener('input', ()=>{ renderTables(); renderOrders(); });
    $('#refreshBtn').addEventListener('click', load);
    load(); setInterval(load, 10000);
</script>
</body>
</html>
