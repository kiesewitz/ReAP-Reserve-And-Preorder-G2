<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Reservieren</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<p class="bigtitle">Reservieren</p>

<div class="restaurant-container" id="restaurantContainer">
    <!--The cards of the restaurants go here-->
</div>

<script>
    fetch("/restaurant")
        .then(response => response.json())
        .then(restaurants => {
            const container = document.getElementById("restaurantContainer");

            restaurants.forEach(r => {
                const card = document.createElement("div");
                card.className = "restaurant-card";
                card.innerHTML = `
            <h2>${r.restaurantName}</h2>
            <p>${r.description}</p>
            <p><strong>Adresse:</strong> ${r.address}</p>
            <p><strong>Telefon:</strong> ${r.phoneNumber}</p>

            <div class="reserve-form">
              <input type="datetime-local" class="datetime-input" placeholder="Datum & Uhrzeit" required>
              <input type="number" class="guests-input" placeholder="Anzahl G채ste" min="1" max="20" required>
                            <input type="tel" class="group-phone-input" placeholder="Telefonnummer f체r R체ckruf" required inputmode="tel">
              <button class="reserve-btn" data-restaurant-id="${r.id}">Reservieren</button>
            </div>
          `;
                container.appendChild(card);

                // Event listeners for this card
                const reserveBtn = card.querySelector('.reserve-btn');
                const phoneInput = card.querySelector('.group-phone-input');

                // Hide phone input when logged in
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                if (isLoggedIn) {
                    phoneInput.style.display = 'none';
                    phoneInput.removeAttribute('required');
                }

                phoneInput.addEventListener('input', () => {
                    phoneInput.value = formatPhoneNumber(phoneInput.value);
                });

                // Restore draft (if any)
                const draftKey = `reserveDraft-${r.id}`;
                const draft = localStorage.getItem(draftKey);
                if (draft) {
                    try {
                        const data = JSON.parse(draft);
                        if (data.datetime) card.querySelector('.datetime-input').value = data.datetime;
                        if (data.guests) card.querySelector('.guests-input').value = data.guests;
                        if (data.phone) card.querySelector('.group-phone-input').value = data.phone;
                    } catch (e) {
                        // ignore
                    }
                }

                // Handle reservation submission
                reserveBtn.addEventListener('click', () => {
                    const datetime = card.querySelector('.datetime-input').value;
                    const guests = card.querySelector('.guests-input').value;
                    const restaurantId = reserveBtn.getAttribute('data-restaurant-id');
                    const phoneValue = card.querySelector('.group-phone-input').value.trim();

                    if (!datetime || !guests) {
                        alert('Bitte f체llen Sie alle Felder aus!');
                        return;
                    }

                    if (!isLoggedIn) {
                        // Save draft and redirect to login
                        localStorage.setItem(draftKey, JSON.stringify({
                            datetime,
                            guests,
                            phone: phoneValue
                        }));
                        window.location.href = `login.html?returnUrl=${encodeURIComponent(window.location.pathname + '?restaurant=' + restaurantId)}`;
                        return;
                    }


                    // Prepare reservation data
                    // Convert datetime-local format to ISO-8601 format with seconds
                    const isoDateTime = datetime + ':00'; // Add seconds

                    const customerId = parseInt(localStorage.getItem('customerId') || '1');
                    const reservationData = {
                        customerId: customerId,
                        restaurantId: parseInt(restaurantId),
                        reservationDateTime: isoDateTime,
                        numberOfGuests: parseInt(guests),
                        isGroupReservation: false,
                        phoneNumber: isLoggedIn ? (localStorage.getItem('customerPhone') || null) : phoneValue
                    };

                    const apiUrl = 'http://localhost:8083/api/reservations';
                    let requestBody = reservationData;

                    // Submit reservation
                    fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Reservierung fehlgeschlagen');
                        }
                        return response.json();
                    })
                    .then(reservation => {
                        localStorage.removeItem(draftKey);
                        // Direkt zur Vorbestellung weiterleiten
                        window.location.href = `preorder.html?reservationId=${reservation.id}&restaurantId=${restaurantId}&datetime=${encodeURIComponent(isoDateTime)}&guests=${guests}`;
                    })
                    .catch(err => {
                        console.error('Fehler:', err);
                        alert('Fehler bei der Reservierung: ' + err.message);
                    });
                });
            });
        })
        .catch(err => console.error("Fehler beim Laden:", err));

    function formatPhoneNumber(value) {
        if (!value) return '';
        const hasPlus = value.trim().startsWith('+');
        const digits = value.replace(/\D/g, '');
        const parts = [];
        let i = 0;
        const groups = [2, 3, 3, 4];
        for (const g of groups) {
            if (i >= digits.length) break;
            parts.push(digits.slice(i, i + g));
            i += g;
        }
        if (i < digits.length) {
            parts.push(digits.slice(i));
        }
        return (hasPlus ? '+' : '') + parts.join(' ');
    }
</script>
</body>
</html>
