<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Login / Registrieren</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<p class="bigtitle">Anmelden</p>

<div class="account-tabs">
    <button class="tab-btn active" id="tabLogin">Login</button>
    <button class="tab-btn" id="tabRegister">Registrieren</button>
</div>

<div class="auth-container">
    <div class="account-card" id="loginCard">
        <h2>Login</h2>
        <p class="account-hint">Melde dich mit E‑Mail und Passwort an.</p>
        <input type="email" id="loginEmail" placeholder="E‑Mail">
        <input type="password" id="loginPassword" placeholder="Passwort">
        <button class="btn blue-btn" id="loginBtn" style="width: 100%;">Einloggen</button>
        <div id="loginError" style="color: red; margin-top: 10px; display: none;"></div>
        <div class="account-id">Status: <span id="loginStatus">–</span></div>
    </div>

    <div class="account-card" id="registerCard" style="display:none;">
        <h2>Konto erstellen</h2>
        <p class="account-hint">Erstelle ein Konto mit E‑Mail und Passwort.</p>
        <input type="text" id="customerName" placeholder="Name">
        <input type="email" id="customerEmail" placeholder="E‑Mail">
        <input type="tel" id="customerPhone" placeholder="Telefonnummer" inputmode="tel" required>
        <input type="password" id="customerPassword" placeholder="Passwort wählen (mind. 6 Zeichen)">
        <button class="btn blue-btn" id="createAccountBtn" style="width: 100%;">Konto erstellen</button>
        <div id="registerError" style="color: red; margin-top: 10px; display: none;"></div>
    </div>
</div>

<script>
function setLoginStatus(isLoggedIn) {
    const email = localStorage.getItem('customerEmail');
    document.getElementById('loginStatus').textContent = isLoggedIn
        ? `Eingeloggt${email ? ' (' + email + ')' : ''}`
        : 'Ausgeloggt';
}

function switchTab(tab) {
    const isLogin = tab === 'login';
    document.getElementById('loginCard').style.display = isLogin ? 'block' : 'none';
    document.getElementById('registerCard').style.display = isLogin ? 'none' : 'block';
    document.getElementById('tabLogin').classList.toggle('active', isLogin);
    document.getElementById('tabRegister').classList.toggle('active', !isLogin);
}

async function createAccount() {
    const name = document.getElementById('customerName').value.trim();
    const email = document.getElementById('customerEmail').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const password = document.getElementById('customerPassword').value.trim();

    const errorDiv = document.getElementById('registerError');
    errorDiv.style.display = 'none';

    if (!name || !email || !phone || !password) {
        errorDiv.textContent = 'Bitte alle Felder ausfüllen.';
        errorDiv.style.display = 'block';
        return;
    }

    if (password.length < 6) {
        errorDiv.textContent = 'Passwort muss mindestens 6 Zeichen lang sein.';
        errorDiv.style.display = 'block';
        return;
    }

    // Email-Format-Validierung
    if (!email.match(/^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/)) {
        errorDiv.textContent = 'Ungültiges E-Mail-Format.';
        errorDiv.style.display = 'block';
        return;
    }

    // Telefonnummer-Validierung (muss + und Ziffern enthalten)
    if (!phone.match(/^\+?[0-9\s-]{6,}$/)) {
        errorDiv.textContent = 'Ungültige Telefonnummer. Format: +43 123 456 7890';
        errorDiv.style.display = 'block';
        return;
    }

    try {
        const response = await fetch('http://localhost:8083/api/customers/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password, phoneNumber: phone })
        });

        const data = await response.json();

        if (!response.ok) {
            errorDiv.textContent = data.error || 'Registrierung fehlgeschlagen';
            errorDiv.style.display = 'block';
            return;
        }

        // Erfolgreiche Registrierung - speichere Daten
        localStorage.setItem('customerId', data.id);
        localStorage.setItem('customerName', data.name);
        localStorage.setItem('customerEmail', data.email);
        localStorage.setItem('customerPhone', data.phoneNumber);
        localStorage.setItem('isLoggedIn', 'true');

        setLoginStatus(true);
        alert('Konto erfolgreich erstellt!');

        const returnUrl = new URLSearchParams(window.location.search).get('returnUrl');
        window.location.href = returnUrl || 'reserve.html';
    } catch (err) {
        errorDiv.textContent = 'Fehler bei der Verbindung zum Server.';
        errorDiv.style.display = 'block';
    }
}

async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    const errorDiv = document.getElementById('loginError');
    errorDiv.style.display = 'none';

    if (!email || !password) {
        errorDiv.textContent = 'Bitte E‑Mail und Passwort eingeben.';
        errorDiv.style.display = 'block';
        return;
    }

    try {
        const response = await fetch('http://localhost:8083/api/customers/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
            errorDiv.textContent = 'Login fehlgeschlagen. Bitte überprüfen Sie Ihre E-Mail und Passwort.';
            errorDiv.style.display = 'block';
            return;
        }

        // Erfolgreicher Login - speichere Daten
        localStorage.setItem('customerId', data.id);
        localStorage.setItem('customerName', data.name);
        localStorage.setItem('customerEmail', data.email);
        localStorage.setItem('customerPhone', data.phoneNumber || '');
        localStorage.setItem('isLoggedIn', 'true');

        setLoginStatus(true);
        alert('Login erfolgreich!');

        const returnUrl = new URLSearchParams(window.location.search).get('returnUrl');
        window.location.href = returnUrl || 'reserve.html';
    } catch (err) {
        errorDiv.textContent = 'Fehler bei der Verbindung zum Server. Bitte versuchen Sie es später erneut.';
        errorDiv.style.display = 'block';
    }
}

setLoginStatus(localStorage.getItem('isLoggedIn') === 'true');

document.getElementById('loginBtn').addEventListener('click', login);
document.getElementById('createAccountBtn').addEventListener('click', createAccount);
document.getElementById('tabLogin').addEventListener('click', () => switchTab('login'));
document.getElementById('tabRegister').addEventListener('click', () => switchTab('register'));
</script>
</body>
</html>
