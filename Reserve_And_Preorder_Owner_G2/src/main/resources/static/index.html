<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard - ReAP</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        header p {
            opacity: 0.9;
            margin-top: 5px;
        }
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #2d2d44 0%, #1f1f35 100%);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-card.highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .stat-card .label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 8px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
        }
        .stat-card .icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Section */
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 20px;
            font-weight: 600;
        }

        /* Tables Grid */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }
        .table-card {
            background: #2d2d44;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .table-card:hover { transform: translateY(-3px); }
        .table-card.AVAILABLE { border-left: 4px solid #4CAF50; }
        .table-card.RESERVED { border-left: 4px solid #2196F3; }
        .table-card.OCCUPIED { border-left: 4px solid #FF9800; }
        .table-card.CLEANING { border-left: 4px solid #9C27B0; }
        .table-card .table-number { font-size: 24px; font-weight: 700; }
        .table-card .table-info { font-size: 12px; opacity: 0.7; margin-top: 5px; }
        .table-card .table-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }
        .table-card.AVAILABLE .table-status { background: #4CAF50; }
        .table-card.RESERVED .table-status { background: #2196F3; }
        .table-card.OCCUPIED .table-status { background: #FF9800; }
        .table-card.CLEANING .table-status { background: #9C27B0; }

        /* Reservations */
        .reservations-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 900px) {
            .reservations-container { grid-template-columns: 1fr; }
        }
        .reservation-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .reservation-card {
            background: #2d2d44;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        .reservation-card.PENDING { border-left-color: #FF9800; }
        .reservation-card.CONFIRMED { border-left-color: #4CAF50; }
        .reservation-card.CHECKED_IN { border-left-color: #2196F3; }
        .reservation-card.COMPLETED { border-left-color: #9E9E9E; opacity: 0.7; }
        .reservation-card.CANCELLED { border-left-color: #f44336; opacity: 0.5; }
        .res-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .res-id { font-weight: 700; font-size: 16px; }
        .res-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .res-status.PENDING { background: #FF9800; }
        .res-status.CONFIRMED { background: #4CAF50; }
        .res-status.CHECKED_IN { background: #2196F3; }
        .res-status.COMPLETED { background: #9E9E9E; }
        .res-status.CANCELLED { background: #f44336; }
        .res-info { font-size: 14px; opacity: 0.8; line-height: 1.6; }
        .res-info span { margin-right: 15px; }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #d32f2f; }
        .btn-small { padding: 6px 12px; font-size: 12px; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #2d2d44;
            border-radius: 16px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
        }
        .modal-content h3 { margin-bottom: 20px; }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: #1f1f35;
            color: white;
            font-size: 14px;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons .btn { flex: 1; }

        /* Assign Table */
        .assign-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .assign-section select {
            padding: 8px;
            border-radius: 6px;
            background: #1f1f35;
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            margin-right: 10px;
            appearance: none;
            background-image: linear-gradient(45deg, transparent 50%, #ccc 50%),
                              linear-gradient(135deg, #ccc 50%, transparent 50%);
            background-position: calc(100% - 16px) calc(50% - 3px), calc(100% - 10px) calc(50% - 3px);
            background-size: 6px 6px, 6px 6px;
            background-repeat: no-repeat;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: #667eea; border-radius: 4px; }

        .empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <header>
        <h1>Owner Dashboard</h1>
        <p>Verwaltung von Reservierungen, Tischen und Einnahmen</p>
    </header>

    <main>
        <!-- Stats Section -->
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="icon">üí∞</div>
                <div class="label">Heutige Einnahmen</div>
                <div class="value" id="todayRevenue">‚Ç¨0.00</div>
            </div>
            <div class="stat-card">
                <div class="icon">üìä</div>
                <div class="label">Gesamt Einnahmen</div>
                <div class="value" id="totalRevenue">‚Ç¨0.00</div>
            </div>
            <div class="stat-card">
                <div class="icon">üíµ</div>
                <div class="label">Bar-Zahlungen</div>
                <div class="value" id="cashPayments">‚Ç¨0.00</div>
            </div>
            <div class="stat-card">
                <div class="icon">üí≥</div>
                <div class="label">Karten-Zahlungen</div>
                <div class="value" id="cardPayments">‚Ç¨0.00</div>
            </div>
            <div class="stat-card">
                <div class="icon">üßæ</div>
                <div class="label">Zahlungen Heute</div>
                <div class="value" id="todayCount">0</div>
            </div>
        </div>

        <!-- Tables Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">ü™ë Tische</h2>
                <button class="btn btn-primary" onclick="openTableModal()">+ Neuer Tisch</button>
            </div>
            <div class="tables-grid" id="tablesGrid">
                <div class="empty-state">Lade Tische...</div>
            </div>
        </div>

        <!-- Reservations Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">üìÖ Reservierungen</h2>
                <button class="btn btn-primary btn-small" onclick="refreshAll()">üîÑ Aktualisieren</button>
            </div>
            <div class="reservations-container">
                <div>
                    <h3 style="margin-bottom: 15px; opacity: 0.8;">Aktive Reservierungen</h3>
                    <div class="reservation-list" id="activeReservations">
                        <div class="empty-state">Lade...</div>
                    </div>
                </div>
                <div>
                    <h3 style="margin-bottom: 15px; opacity: 0.8;">Abgeschlossene Reservierungen</h3>
                    <div class="reservation-list" id="completedReservations">
                        <div class="empty-state">Lade...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Table Modal -->
    <div class="modal" id="tableModal">
        <div class="modal-content">
            <h3 id="tableModalTitle">Neuen Tisch erstellen</h3>
            <div style="font-size:14px;opacity:0.8;margin-bottom:10px;">Restaurant: ReAP Fusion Kitchen</div>
            <input type="text" id="tableNumber" placeholder="Tischnummer (z.B. T1)">
            <input type="number" id="tableCapacity" placeholder="Kapazit√§t (Anzahl Pl√§tze)" min="1" max="20">
            <input type="hidden" id="editTableId" value="">
            <div class="modal-buttons">
                <button class="btn" style="background: #666;" onclick="closeTableModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveTable()">Speichern</button>
            </div>
        </div>
    </div>

<script>
const API_BASE = 'http://localhost:8083/api';
let allReservations = [];
let allTables = [];

// Load Stats
async function loadStats() {
    try {
        const res = await fetch(`${API_BASE}/payments/stats`);
        const stats = await res.json();

        document.getElementById('todayRevenue').textContent = `‚Ç¨${parseFloat(stats.todayRevenue || 0).toFixed(2)}`;
        document.getElementById('totalRevenue').textContent = `‚Ç¨${parseFloat(stats.totalRevenue || 0).toFixed(2)}`;
        document.getElementById('cashPayments').textContent = `‚Ç¨${parseFloat(stats.cashPayments || 0).toFixed(2)}`;
        document.getElementById('cardPayments').textContent = `‚Ç¨${parseFloat(stats.cardPayments || 0).toFixed(2)}`;
        document.getElementById('todayCount').textContent = stats.todayCount || 0;
    } catch (e) {
        console.error('Error loading stats:', e);
    }
}

// Load Tables
async function loadTables() {
    try {
        const res = await fetch(`${API_BASE}/tables`);
        allTables = await res.json();
        renderTables();
    } catch (e) {
        console.error('Error loading tables:', e);
        document.getElementById('tablesGrid').innerHTML = '<div class="empty-state">Fehler beim Laden</div>';
    }
}

function renderTables() {
    const grid = document.getElementById('tablesGrid');
    if (!allTables.length) {
        grid.innerHTML = '<div class="empty-state">Keine Tische vorhanden</div>';
        return;
    }

    grid.innerHTML = allTables.map(t => `
        <div class="table-card ${t.status}">
            <div class="table-number">T${t.tableNumber}</div>
            <div class="table-info">${t.capacity} Pl√§tze</div>
            <div class="table-status">${getStatusText(t.status)}</div>
            <div style="margin-top:10px;">
                <button class="btn btn-primary btn-small" onclick="openEditTable(${t.id})">Bearbeiten</button>
            </div>
        </div>
    `).join('');
}

function getStatusText(status) {
    const map = {
        'AVAILABLE': 'Frei',
        'RESERVED': 'Reserviert',
        'OCCUPIED': 'Belegt',
        'CLEANING': 'Abservieren'
    };
    return map[status] || status;
}

// Load Reservations
async function loadReservations() {
    try {
        const res = await fetch(`${API_BASE}/reservations`);
        allReservations = await res.json();
        renderReservations();
    } catch (e) {
        console.error('Error loading reservations:', e);
    }
}

function renderReservations() {
    const activeContainer = document.getElementById('activeReservations');
    const completedContainer = document.getElementById('completedReservations');

    const active = allReservations.filter(r =>
        ['PENDING', 'CONFIRMED', 'CHECKED_IN'].includes(r.status)
    ).sort((a, b) => new Date(a.reservationDateTime) - new Date(b.reservationDateTime));

    const completed = allReservations.filter(r =>
        ['COMPLETED', 'CANCELLED', 'NO_SHOW'].includes(r.status)
    ).sort((a, b) => new Date(b.reservationDateTime) - new Date(a.reservationDateTime)).slice(0, 20);

    if (!active.length) {
        activeContainer.innerHTML = '<div class="empty-state">Keine aktiven Reservierungen</div>';
    } else {
        activeContainer.innerHTML = active.map(r => renderReservationCard(r, true)).join('');
    }

    if (!completed.length) {
        completedContainer.innerHTML = '<div class="empty-state">Keine abgeschlossenen Reservierungen</div>';
    } else {
        completedContainer.innerHTML = completed.map(r => renderReservationCard(r, false)).join('');
    }
}

function renderReservationCard(res, showAssign) {
    const dt = new Date(res.reservationDateTime);
    const dateStr = dt.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const timeStr = dt.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

    const assignedTable = res.tableId ? allTables.find(t => t.id === res.tableId) : null;
    const tableInfo = assignedTable ? `Tisch ${assignedTable.tableNumber}` : 'Kein Tisch';

    // Filter available tables for assignment
    const availableForAssign = allTables.filter(t =>
        t.capacity >= res.numberOfGuests &&
        (t.status === 'AVAILABLE' || t.id === res.tableId)
    );

    let assignHtml = '';
    if (showAssign && !res.tableId && (res.status === 'PENDING' || res.status === 'CONFIRMED')) {
        if (availableForAssign.length) {
            const options = availableForAssign.map(t =>
                `<option value="${t.id}">T${t.tableNumber} (${t.capacity}P)</option>`
            ).join('');
            assignHtml = `
                <div class="assign-section">
                    <select id="assign-${res.id}">
                        <option value="">Tisch w√§hlen</option>
                        ${options}
                    </select>
                    <button class="btn btn-success btn-small" onclick="assignTable(${res.id})">Zuweisen</button>
                </div>
            `;
        } else {
            assignHtml = `
                <div class="assign-section" style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #FF9800;">‚ö†Ô∏è Keine passenden Tische verf√ºgbar</span>
                    <button class="btn btn-danger btn-small" onclick="rejectReservation(${res.id})">‚ùå Ablehnen</button>
                </div>
            `;
        }
    }

    return `
        <div class="reservation-card ${res.status}">
            <div class="res-header">
                <span class="res-id">#${res.id}</span>
                <span class="res-status ${res.status}">${res.status}</span>
            </div>
            <div class="res-info">
                <span>üìÖ ${dateStr}</span>
                <span>‚è∞ ${timeStr}</span>
                <span>üë• ${res.numberOfGuests}</span>
                <span>ü™ë ${tableInfo}</span>
                ${res.phoneNumber ? `<span>üìû ${res.phoneNumber}</span>` : ''}
            </div>
            ${assignHtml}
        </div>
    `;
}

async function assignTable(reservationId) {
    const select = document.getElementById(`assign-${reservationId}`);
    const tableId = select.value;
    if (!tableId) {
        alert('Bitte einen Tisch w√§hlen');
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/tables/${tableId}/assign/${reservationId}`, {
            method: 'POST'
        });
        if (!res.ok) throw new Error('Fehler bei Zuweisung');

        alert('‚úì Tisch erfolgreich zugewiesen!');
        refreshAll();
    } catch (e) {
        alert('‚ùå ' + e.message);
    }
}

async function rejectReservation(reservationId) {
    if (!confirm('Reservierung #' + reservationId + ' wirklich ablehnen?\n\nDer Kunde wird benachrichtigt, dass kein Tisch verf√ºgbar ist.')) {
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/reservations/${reservationId}`, {
            method: 'DELETE'
        });
        if (!res.ok) throw new Error('Fehler beim Ablehnen');

        alert('‚úì Reservierung wurde abgelehnt.');
        refreshAll();
    } catch (e) {
        alert('‚ùå ' + e.message);
    }
}

// Table Modal
function openTableModal() {
    document.getElementById('tableModal').classList.add('active');
    document.getElementById('tableModalTitle').textContent = 'Neuen Tisch erstellen';
    document.getElementById('editTableId').value = '';
}

function closeTableModal() {
    document.getElementById('tableModal').classList.remove('active');
    document.getElementById('tableNumber').value = '';
    document.getElementById('tableCapacity').value = '';
    document.getElementById('editTableId').value = '';
}

function openEditTable(id) {
    const table = allTables.find(t => t.id === id);
    if (!table) return;
    document.getElementById('tableModal').classList.add('active');
    document.getElementById('tableModalTitle').textContent = 'Tisch bearbeiten';
    document.getElementById('editTableId').value = id;
    document.getElementById('tableNumber').value = table.tableNumber;
    document.getElementById('tableCapacity').value = table.capacity;
}

async function saveTable() {
    const restaurantId = 1;
    const tableNumber = document.getElementById('tableNumber').value;
    const capacity = parseInt(document.getElementById('tableCapacity').value);
    const editId = document.getElementById('editTableId').value;

    if (!tableNumber || !capacity) {
        alert('Bitte alle Felder ausf√ºllen!');
        return;
    }

    try {
        const url = editId ? `${API_BASE}/tables/${editId}` : `${API_BASE}/tables`;
        const method = editId ? 'PUT' : 'POST';

        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ restaurantId, tableNumber, capacity })
        });

        if (!res.ok) throw new Error('Fehler beim Erstellen');

        alert(editId ? '‚úì Tisch aktualisiert!' : '‚úì Tisch erfolgreich erstellt!');
        closeTableModal();
        loadTables();
    } catch (e) {
        alert('‚ùå ' + e.message);
    }
}

// Refresh all
function refreshAll() {
    loadStats();
    loadTables();
    loadReservations();
}

// Initial load
refreshAll();

// Auto-refresh every 10 seconds
setInterval(refreshAll, 10000);

// Close modal on outside click
document.getElementById('tableModal').addEventListener('click', function(e) {
    if (e.target === this) closeTableModal();
});

console.log('Owner Dashboard geladen - Auto-Refresh alle 10 Sekunden');
</script>
</body>
</html>
