<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Reservierungen - Owner App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .reservation-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .reservation-item {
            padding: 15px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 4px;
            background: #fafafa;
        }
        .reservation-item.PENDING {
            border-left: 4px solid #ff9800;
        }
        .reservation-item.CONFIRMED {
            border-left: 4px solid #4caf50;
        }
        .reservation-item.CHECKED_IN {
            border-left: 4px solid #2196f3;
        }
        .reservation-item.COMPLETED {
            border-left: 4px solid #9e9e9e;
        }
        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .reservation-id {
            font-weight: bold;
            font-size: 1.1em;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            color: white;
        }
        .status-PENDING { background-color: #ff9800; }
        .status-CONFIRMED { background-color: #4caf50; }
        .status-CHECKED_IN { background-color: #2196f3; }
        .status-COMPLETED { background-color: #9e9e9e; }
        .status-CANCELLED { background-color: #f44336; }
        .status-NO_SHOW { background-color: #e91e63; }
        .reservation-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        .detail-item {
            font-size: 0.9em;
        }
        .detail-label {
            font-weight: bold;
            color: #666;
        }
        .assign-table {
            margin-top: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
        }
        select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        button {
            padding: 8px 16px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #1976d2;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .refresh-btn {
            margin-bottom: 20px;
            background-color: #4caf50;
        }
        .refresh-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Reservierungen verwalten</h1>

    <button class="refresh-btn" onclick="loadReservations()">ðŸ”„ Aktualisieren</button>

    <div class="reservation-list" id="reservationList">
        <p>Lade Reservierungen...</p>
    </div>

    <script>
        let availableTables = [];

        // Load available tables
        function loadTables() {
            fetch('http://localhost:8083/api/tables')
                .then(res => res.json())
                .then(tables => {
                    availableTables = tables;
                    console.log('Loaded ' + tables.length + ' tables');
                })
                .catch(err => console.error('Error loading tables:', err));
        }

        // Load reservations
        function loadReservations() {
            fetch('http://localhost:8083/api/reservations')
                .then(res => res.json())
                .then(reservations => {
                    displayReservations(reservations);
                })
                .catch(err => {
                    console.error('Error loading reservations:', err);
                    document.getElementById('reservationList').innerHTML =
                        '<p style="color: red;">Fehler beim Laden der Reservierungen</p>';
                });
        }

        // Display reservations
        function displayReservations(reservations) {
            const container = document.getElementById('reservationList');

            if (reservations.length === 0) {
                container.innerHTML = '<p>Keine Reservierungen vorhanden.</p>';
                return;
            }

            // Sort by datetime (newest first)
            reservations.sort((a, b) =>
                new Date(b.reservationDateTime) - new Date(a.reservationDateTime)
            );

            container.innerHTML = reservations.map(res => {
                const datetime = new Date(res.reservationDateTime);
                const formattedDate = datetime.toLocaleDateString('de-DE');
                const formattedTime = datetime.toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Filter tables by restaurant and capacity
                const suitableTables = availableTables.filter(t =>
                    t.restaurantId === res.restaurantId &&
                    t.capacity >= res.numberOfGuests
                );

                const tableOptions = suitableTables.map(t =>
                    `<option value="${t.id}" ${t.id === res.tableId ? 'selected' : ''}>
                        Tisch ${t.tableNumber} (${t.capacity} PlÃ¤tze) - ${t.status}
                    </option>`
                ).join('');

                const showAssignment = res.status === 'PENDING' || res.status === 'CONFIRMED';

                return `
                    <div class="reservation-item ${res.status}">
                        <div class="reservation-header">
                            <span class="reservation-id">Reservierung #${res.id}</span>
                            <span class="status-badge status-${res.status}">${res.status}</span>
                        </div>

                        <div class="reservation-details">
                            <div class="detail-item">
                                <span class="detail-label">Restaurant:</span> ${res.restaurantId}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Datum:</span> ${formattedDate} um ${formattedTime}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">GÃ¤ste:</span> ${res.numberOfGuests}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Tisch:</span> ${res.tableId || 'Noch nicht zugewiesen'}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Dauer:</span> ${res.durationMinutes} Min
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Gruppe:</span> ${res.groupReservation ? 'Ja' : 'Nein'}
                            </div>
                        </div>

                        ${showAssignment ? `
                            <div class="assign-table">
                                <strong>Tisch zuweisen:</strong><br><br>
                                <select id="table-select-${res.id}">
                                    <option value="">-- Tisch wÃ¤hlen --</option>
                                    ${tableOptions}
                                </select>
                                <button onclick="assignTable(${res.id})">Zuweisen</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Assign table to reservation
        function assignTable(reservationId) {
            const selectEl = document.getElementById(`table-select-${reservationId}`);
            const tableId = selectEl.value;

            if (!tableId) {
                alert('Bitte wÃ¤hlen Sie einen Tisch aus');
                return;
            }

            fetch(`http://localhost:8083/api/tables/${tableId}/assign/${reservationId}`, {
                method: 'POST'
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error('Fehler beim Zuweisen');
                }
                return res.json();
            })
            .then(() => {
                alert('Tisch erfolgreich zugewiesen!');
                loadReservations();
            })
            .catch(err => {
                console.error('Error assigning table:', err);
                alert('Fehler beim Zuweisen des Tisches');
            });
        }

        // Initialize
        loadTables();
        loadReservations();

        // Auto-refresh every 30 seconds
        setInterval(loadReservations, 30000);
    </script>
</body>
</html>
